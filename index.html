<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-US">
<head>
<title>Infra-ansible</title>
<meta name="generator" content=
"HTML Tidy for Linux/x86 (vers 1st November 2003), see www.w3.org" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="copyright" content=
"Copyright &#169; 2005-2010 W3C (MIT, ERCIM, Keio)" />
<meta name="duration" content="60" />
<meta name="font-size-adjustment" content="0" />
<link rel="stylesheet" href="styles/slidy.css" type="text/css" />
<link rel="stylesheet" href="styles/openstack.css" type="text/css" />
<script src="scripts/slidy.js" charset="utf-8" type="text/javascript"></script>
</head>
<body>
<div class="background"><img alt="" id="head-icon"
src="graphics/openstack-cloud-software-horizontal-small.png" /></div>

<div class="slide cover titlepage">
  <!-- hidden style graphics to ensure they are saved with other content -->
  <img class="hidden" src="graphics/bullet.png" alt="" />
  <img class="hidden" src="graphics/fold.gif" alt="" />
  <img class="hidden" src="graphics/unfold.gif" alt="" />
  <img class="hidden" src="graphics/fold-dim.gif" alt="" />
  <img class="hidden" src="graphics/nofold-dim.gif" alt="" />
  <img class="hidden" src="graphics/unfold-dim.gif" alt="" />
  <img class="hidden" src="graphics/bullet-fold.gif" alt="" />
  <img class="hidden" src="graphics/bullet-unfold.gif" alt="" />
  <img class="hidden" src="graphics/bullet-fold-dim.gif" alt="" />
  <img class="hidden" src="graphics/bullet-nofold-dim.gif" alt="" />
  <img class="hidden" src="graphics/bullet-unfold-dim.gif" alt="" />
  <img src="graphics/openstack-cloud-software-vertical-large.png" alt="OpenStack logo" class="cover" />
  <h1>Infra-ansible<br />
  <span class="smaller">A set of playbooks to bring up a full Openstack Infra from scratch</span></h1>
  <hr />
  <div class="smaller">Ricardo Carrillo Cruz
    &lt;<a href="mailto:ricardo.carrillo.cruz@gmail.com">ricardo.carrillo.cruz@gmail.com</a>&gt;</div>
</div>

<div class="slide">
  <h1>Why deploying Openstack CI like upstream does</h1>

  <ul>
    <li>Test, debug and fix Openstack CI upstream issues</li>
    <li>Demo installations to see if Openstack CI framework fits groups/users requirements</li>
    <li>Test upgrades of key components (e.g. Gerrit) or new features prior to applying changes on already deployed Openstack CI based infras</li>
    <li>For fun? Not sure about this...</li>
  </ul>

</div>

<div class="slide">
  <h1>Real user story</h1>

  <ol>
    <li>User opens a story on SB to develop a Jira-Jeepyb closed-loop process integration</li>
    <li>Clones system-config from git.openstack.org, edits site.pp and puts its own values</li>
    <li>Fires puppet apply against site.pp and awaits for getting a nice gerrit server to test</li>
    <li>Puppet failures, turns out puppet manifest does not create MySQL DB for Gerrit, since upstream uses Trove</li>
    <li>User creates MySQL DB and DB user needed after investigating manifests/templates and runs puppet again</li>
    <li>Puppet failures, Apache expects certs for FQDN are created upfront</li>
    <li>User generates SSL certificates by googling, runs puppet again</li>
    <li>Puppet failures again, turns out the manifest expects SSL chain file intermediate.pem</li>
    <li>User investigates manifests and finds out it can just point to snake oil certs and not user an SSL chain file at all, runs puppet again</li>
    <li>Puppet failures again, some error about contactstore</li>
    <li>User gets some booze and calls it a day</li>
  </ol>

</div>

<div class="slide">
  <h1>Why is it so hard to deploy Openstack Infra like upstream does</h1>
  <p> Excerpt from <a href=http://ci.openstack.org/running-your-own.html>http://ci.openstack.org/running-your-own.html</a>:</p>
  <pre>
    The minimum set of things to port across is:

    modules/openstack_project/manifests/params.pp
    modules/openstack_project/manifests/server.pp
    modules/openstack_project/manifests/template.pp
    modules/openstack_project/manifests/automatic_upgrades.pp
    modules/openstack_project/manifests/base.pp May need additional changes beyond the search/replace? - User list.
    modules/openstack_project/manifests/users.pp
    modules/openstack_project/manifests/puppetmaster.pp
    modules/openstack_project/templates/puppet.conf.erb
    The default node definition in site.pp
    The puppetmaster definition in site.pp
    The puppetdb definition in site.pp
  </pre>
  <ul>
    <li>system-config mixes code AND config values</li>
    <li>Manifests code have hardcoded values</li>
    <li>Manifests class signatures don't have testmode flags or defaults for test environments</li>
    <li>Branching system-config and modifying a lot of stuff is needed to deploy it properly</li>
  </ul>
</div>

<div class="slide">
  <h1>What is infra-ansible about</h1>

  <ul>
    <li>Uses Ansible to provision infra servers and orchestrate the deployment of services</li>
    <li>It runs Puppet and uses system-config Puppet manifests, it does not replace Puppet for config management</li>
    <li>Uses the new Openstack Ansible modules that are based in Shade, currently awaiting merge in Ansible upstream</li>
    <li>Easy to use, brings up an Infra for development purposes <b>(NOT FOR PRODUCTION)</b></li>
  </ul>
</div>

<div class="slide">
  <h1>How infra-ansible works</h1>

  <ol>
    <li>Define a YAML file (e.g. infra_config.yml) that defines your infra servers and your forked system-config repo and branch</li>
    <pre>
      ---
      system_config_repo_url: git@your_git_server/system-config.git        
      system_config_repo_https_url: https://your_git_server/system-config.git         
      system_config_branch: infra_config   
      key_name: your_openstack_key
      infra_servers:
      - name: puppetmaster.yourdomain.cloud
        image: 9d25fe2d-cf31-4b05-8c58-f238ec78e633
        flavor: standard.small
        net_name: your_neutron_network
        security_groups: default
        infra_type: puppetmaster
      - name: zuul.yourdomain.cloud
        image: 9d25fe2d-cf31-4b05-8c58-f238ec78e633
        flavor: standard.small
        net_name: your_neutron_network
        security_groups: default
        infra_type: zuul
        ...
        ...
    </pre>
    <li><em>ansible-playbook -i YOUR_LOCAL_ANSIBLE_REPO_LOCATION/openstack.py -e "@infra_config.yml" provision_infra_servers.yml</em></li>
    <li><em>ansible-playbook -i YOUR_LOCAL_ANSIBLE_REPO_LOCATION/openstack.py -e "@infra_config.yml" site.yml</em></li>
    <li>Go grab a coffe</li>
    <li>When prompted by Ansible, login to your new Gerrit instance with your Launchpad ID, set up your username and pubkey and type that username in the Ansible prompt</li>
    <li>Wait some more</li>
    <li>Profit! You have a dev Infra comprised of Puppetmaster, Gerrit, Jenkins and Zuul (Nodepool very soon automated as well!)</li>
  </ul>
</div>

<div class="slide">
  <h1>Thanks!</h1>

  <p><img src="images/stack-o-pancakes-150x150.png"/>

  <p>infra-ansible is available at: <a href="http://github.com:rcarrillocruz/infra-ansible.git">http://github.com:rcarrillocruz/infra-ansible.git</a> </p>
  <p>infra-ansible is currently a WIP, will be pushed to Stackforge when it is more polished and automates the deployment of all basic OpenStack Infra services</p> 

</div>

</body>
</html>
